@startuml ProspectOS - Fluxo Completo

!define RECTANGLE class

skinparam backgroundColor #FEFEFE
skinparam shadowing false
skinparam defaultFontName Arial

title ProspectOS - Fluxo Completo de Prospecção B2B

actor "Usuário\n(SDR/BDR)" as User
participant "API REST\n(Spring Boot)" as API
participant "Enrichment\nOrchestrator" as Enrichment
participant "AI Module\n(Spring AI)" as AI
participant "Scraper\n(Python MCP)" as Scraper
participant "LLM\n(OpenAI/Claude)" as LLM
database "PostgreSQL" as DB
database "Redis\nCache" as Cache

== 1. Definir ICP ==
User -> API: POST /prospect\n{"icp": {...}}
activate API
API -> DB: Salvar ICP
API --> User: 202 Accepted\n{"jobId": "123"}
deactivate API

== 2. Buscar Candidatas ==
activate Enrichment
Enrichment -> DB: SELECT * FROM companies\nWHERE industry IN (...)
DB --> Enrichment: List<Company> (100 candidatas)

== 3. Para cada candidata ==
loop Para cada empresa candidata

    == 3.1 AI decide investigar? ==
    Enrichment -> AI: shouldInvestigate(company, icp)
    activate AI
    AI -> LLM: "Esta empresa match com ICP?\n{company}\n{icp}"
    activate LLM
    LLM --> AI: "SIM, 75% match"
    deactivate LLM
    AI --> Enrichment: true
    deactivate AI

    alt AI decidiu NÃO investigar
        Enrichment -> Enrichment: Skip empresa
    end

    == 3.2 Scraping (via MCP) ==
    Enrichment -> Scraper: scrape(website)
    activate Scraper
    Scraper -> Scraper: BeautifulSoup\nparse HTML
    Scraper -> Cache: SET data (TTL 24h)
    Scraper --> Enrichment: {"emails": [...],\n"tech_stack": [...]}
    deactivate Scraper

    == 3.3 Buscar Notícias ==
    Enrichment -> Scraper: searchNews(companyName)
    activate Scraper
    Scraper -> Scraper: Google News API
    Scraper --> Enrichment: ["Funding round $10M",\n"Expansion to LATAM"]
    deactivate Scraper

    == 3.4 AI Enrichment ==
    Enrichment -> AI: enrichCompany(company)
    activate AI
    AI -> LLM: "Analise empresa:\n{scraped_data}\n{news}"
    note right
        LLM pode chamar functions:
        - scrapeWebsite()
        - searchNews()
        - analyzeSignals()
    end note
    activate LLM
    LLM -> AI: call function scrapeWebsite()
    AI -> Scraper: scrape(...)
    Scraper --> AI: result
    AI -> LLM: function result
    LLM --> AI: "Empresa usa Salesforce,\n50 funcionários,\nB2B SaaS..."
    deactivate LLM
    AI --> Enrichment: aiAnalysis
    deactivate AI

    == 3.5 AI Scoring ==
    Enrichment -> AI: scoreCompany(company, icp)
    activate AI
    AI -> LLM: "Calcule score (0-100):\n{company}\n{analysis}\n{icp}"
    activate LLM
    LLM --> AI: {"score": 85,\n"priority": "HOT",\n"reasoning": "..."}
    deactivate LLM
    AI --> Enrichment: ScoringResult
    deactivate AI

    == 3.6 AI Strategy ==
    Enrichment -> AI: recommendStrategy(company)
    activate AI
    AI -> LLM: "Recomende estratégia:\n{company}\n{score}"
    activate LLM
    LLM --> AI: "Contatar CTO via LinkedIn,\nfoco em automação..."
    deactivate LLM
    AI --> Enrichment: strategy
    deactivate AI

    == 3.7 Salvar ==
    Enrichment -> DB: UPDATE company\nSET score=85,\nai_analysis=...,\nstrategy=...
    DB --> Enrichment: OK

    == 3.8 Publicar Evento ==
    Enrichment -> Enrichment: publishEvent(\nCompanyScored)
    note right
        Outros módulos podem
        escutar e reagir
    end note
end

deactivate Enrichment

== 4. Retornar Resultado ==
API -> DB: SELECT * FROM companies\nWHERE score >= 50\nORDER BY score DESC
DB --> API: List<Company> (prospectadas)
API --> User: 200 OK\n{"companies": [...],\n"stats": {...}}

@enduml